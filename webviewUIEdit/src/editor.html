<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>移动端优化代码编辑器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: none;
            text-size-adjust: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
        }
        
        /* 头部工具栏 */
        .toolbar {
            background: #2d2d30;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3e3e42;
            flex-shrink: 0;
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .toolbar-button {
            background: transparent;
            border: none;
            color: #cccccc;
            font-size: 18px;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .toolbar-button:active {
            background: #3e3e42;
        }
        
        .filename {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }
        
        /* 编辑器容器 */
        .editor-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }
        
        .line-numbers {
            background: #1e1e1e;
            color: #6e7681;
            padding: 15px 8px 15px 15px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 24px;
            user-select: none;
            overflow-y: hidden;
            flex-shrink: 0;
            width: 60px;
            border-right: 1px solid #3e3e42;
        }
        
        .editor-area {
            flex: 1;
            padding: 15px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #code-input {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            line-height: 24px;
            resize: none;
            tab-size: 4;
            -moz-tab-size: 4;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        
        /* 移动端键盘工具栏 */
        .keyboard-toolbar {
            background: #2d2d30;
            border-top: 1px solid #3e3e42;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .keyboard-button {
            background: #3c3c3c;
            border: 1px solid #464647;
            color: #cccccc;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            min-width: 50px;
            text-align: center;
            transition: background 0.2s;
            touch-action: manipulation;
        }
        
        .keyboard-button:active {
            background: #0e639c;
        }
        
        .keyboard-button.wide {
            flex: 1;
        }
        
        /* 语法高亮 */
        .keyword { color: #569cd6; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; font-style: italic; }
        .number { color: #b5cea8; }
        .function { color: #dcdcaa; }
        .operator { color: #d4d4d4; }
        
        /* 触摸选择菜单 */
        .selection-menu {
            position: absolute;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .selection-menu button {
            background: transparent;
            border: none;
            color: #cccccc;
            padding: 12px 16px;
            width: 100%;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
        }
        
        .selection-menu button:last-child {
            border-bottom: none;
        }
        
        .selection-menu button:active {
            background: #094771;
        }
        
        /* 自动完成 */
        .autocomplete {
            position: absolute;
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-item.active {
            background: #094771;
        }
        
        .autocomplete-item i {
            color: #569cd6;
            width: 20px;
        }
        
        /* 状态栏 */
        .status-bar {
            background: #0078d4;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        /* 响应式设计 */
        @media (max-width: 480px) {
            .toolbar {
                padding: 10px 12px;
            }
            
            .toolbar-button {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
            
            .filename {
                font-size: 14px;
            }
            
            .line-numbers {
                font-size: 14px;
                line-height: 22px;
                padding: 12px 6px 12px 12px;
                width: 50px;
            }
            
            #code-input {
                font-size: 14px;
                line-height: 22px;
            }
            
            .keyboard-button {
                padding: 8px 12px;
                font-size: 14px;
                min-width: 44px;
            }
        }
        
        @media (max-height: 600px) {
            .keyboard-toolbar {
                display: none;
            }
        }
        
        /* 防止iOS橡皮筋效果 */
        body {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="toolbar">
            <div class="toolbar-left">
                <button class="toolbar-button" id="menu-button">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="filename">script.js</span>
            </div>
            <div class="toolbar-right">
                <button class="toolbar-button" id="undo-button" title="撤销">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="toolbar-button" id="redo-button" title="重做">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="toolbar-button" id="theme-button" title="切换主题">
                    <i class="fas fa-palette"></i>
                </button>
            </div>
        </div>
        
        <div class="editor-wrapper">
            <div class="line-numbers" id="line-numbers">1</div>
            <div class="editor-area">
                <textarea id="code-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
            </div>
        </div>
        
        <div class="keyboard-toolbar" id="keyboard-toolbar">
            <button class="keyboard-button" data-insert="    ">Tab</button>
            <button class="keyboard-button" data-insert="()">()</button>
            <button class="keyboard-button" data-insert="[]">[]</button>
            <button class="keyboard-button" data-insert="{}">{}</button>
            <button class="keyboard-button" data-insert="''">''</button>
            <button class="keyboard-button" data-insert='""'>""</button>
            <button class="keyboard-button" data-insert="=>">=></button>
            <button class="keyboard-button wide" id="hide-keyboard">隐藏键盘</button>
        </div>
        
        <div class="status-bar">
            <div>JavaScript</div>
            <div id="cursor-position">行 1, 列 1</div>
        </div>
        
        <div class="selection-menu" id="selection-menu">
            <button id="cut-button">剪切</button>
            <button id="copy-button">复制</button>
            <button id="paste-button">粘贴</button>
            <button id="select-all-button">全选</button>
        </div>
        
        <div class="autocomplete" id="autocomplete">
            <!-- 自动完成项将通过JavaScript动态添加 -->
        </div>
    </div>

    <script>
        // 初始化代码编辑器
        class MobileCodeEditor {
            constructor() {
                this.editor = document.getElementById('code-input');
                this.lineNumbers = document.getElementById('line-numbers');
                this.cursorPosition = document.getElementById('cursor-position');
                this.selectionMenu = document.getElementById('selection-menu');
                this.autocomplete = document.getElementById('autocomplete');
                this.keyboardToolbar = document.getElementById('keyboard-toolbar');
                
                this.isDarkTheme = true;
                this.undoStack = [];
                this.redoStack = [];
                this.currentState = '';
                
                this.init();
            }
            
            init() {
                // 设置初始内容
                this.setInitialContent();
                
                // 事件监听
                this.setupEventListeners();
                
                // 更新行号
                this.updateLineNumbers();
                
                // 保存初始状态
                this.saveState();
            }
            
            setInitialContent() {
                const initialCode = `// 移动端优化代码编辑器
// 专为触摸设备设计

function greet(name) {
    return "Hello, " + name + "!";
}

const user = {
    name: "移动开发者",
    age: 30,
    skills: ["JavaScript", "HTML", "CSS"]
};

// 使用示例
console.log(greet(user.name));

// 数组操作示例
const numbers = [1, 2, 3, 4, 5];
const doubled = numbers.map(n => n * 2);
console.log(doubled);

// 条件语句示例
if (user.age >= 18) {
    console.log("成年人");
} else {
    console.log("未成年人");
}`;

                this.editor.value = initialCode;
            }
            
            setupEventListeners() {
                // 编辑器内容变化
                this.editor.addEventListener('input', () => {
                    this.updateLineNumbers();
                    this.updateCursorPosition();
                    this.saveState();
                    this.checkForAutocomplete();
                });
                
                // 光标移动
                this.editor.addEventListener('click', () => {
                    this.updateCursorPosition();
                });
                
                this.editor.addEventListener('keyup', () => {
                    this.updateCursorPosition();
                });
                
                // 触摸事件处理
                this.editor.addEventListener('touchstart', this.handleTouchStart.bind(this));
                this.editor.addEventListener('touchend', this.handleTouchEnd.bind(this));
                
                // 键盘工具栏按钮
                document.querySelectorAll('.keyboard-button[data-insert]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.insertText(e.target.getAttribute('data-insert'));
                        this.editor.focus();
                    });
                });
                
                // 隐藏键盘按钮
                document.getElementById('hide-keyboard').addEventListener('click', () => {
                    this.editor.blur();
                });
                
                // 工具栏按钮
                document.getElementById('undo-button').addEventListener('click', () => this.undo());
                document.getElementById('redo-button').addEventListener('click', () => this.redo());
                document.getElementById('theme-button').addEventListener('click', () => this.toggleTheme());
                
                // 选择菜单
                document.getElementById('cut-button').addEventListener('click', () => this.cut());
                document.getElementById('copy-button').addEventListener('click', () => this.copy());
                document.getElementById('paste-button').addEventListener('click', () => this.paste());
                document.getElementById('select-all-button').addEventListener('click', () => this.selectAll());
                
                // 点击其他地方隐藏菜单
                document.addEventListener('click', (e) => {
                    if (!this.selectionMenu.contains(e.target) && e.target !== this.editor) {
                        this.hideSelectionMenu();
                    }
                });
                
                // 防止页面滚动
                document.addEventListener('touchmove', (e) => {
                    if (e.target === this.editor) {
                        e.preventDefault();
                    }
                }, { passive: false });
            }
            
            handleTouchStart(e) {
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
                this.touchStartTime = Date.now();
            }
            
            handleTouchEnd(e) {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndTime = Date.now();
                
                const deltaX = Math.abs(touchEndX - this.touchStartX);
                const deltaY = Math.abs(touchEndY - this.touchStartY);
                const duration = touchEndTime - this.touchStartTime;
                
                // 长按显示选择菜单
                if (duration > 500 && deltaX < 10 && deltaY < 10) {
                    this.showSelectionMenu(this.touchStartX, this.touchStartY);
                }
            }
            
            showSelectionMenu(x, y) {
                this.selectionMenu.style.left = x + 'px';
                this.selectionMenu.style.top = y + 'px';
                this.selectionMenu.style.display = 'block';
            }
            
            hideSelectionMenu() {
                this.selectionMenu.style.display = 'none';
            }
            
            cut() {
                document.execCommand('cut');
                this.hideSelectionMenu();
            }
            
            copy() {
                document.execCommand('copy');
                this.hideSelectionMenu();
            }
            
            async paste() {
                try {
                    const text = await navigator.clipboard.readText();
                    this.insertText(text);
                } catch (err) {
                    // 降级方案
                    document.execCommand('paste');
                }
                this.hideSelectionMenu();
            }
            
            selectAll() {
                this.editor.select();
                this.hideSelectionMenu();
            }
            
            insertText(text) {
                const start = this.editor.selectionStart;
                const end = this.editor.selectionEnd;
                const value = this.editor.value;
                
                this.editor.value = value.substring(0, start) + text + value.substring(end);
                this.editor.selectionStart = this.editor.selectionEnd = start + text.length;
                this.editor.focus();
                
                this.updateLineNumbers();
                this.saveState();
            }
            
            updateLineNumbers() {
                const lineCount = this.editor.value.split('\n').length;
                let numbers = '';
                
                for (let i = 1; i <= lineCount; i++) {
                    numbers += i + '\n';
                }
                
                this.lineNumbers.textContent = numbers;
            }
            
            updateCursorPosition() {
                const value = this.editor.value;
                const cursorPos = this.editor.selectionStart;
                
                const textBeforeCursor = value.substring(0, cursorPos);
                const line = textBeforeCursor.split('\n').length;
                const column = textBeforeCursor.split('\n').pop().length + 1;
                
                this.cursorPosition.textContent = `行 ${line}, 列 ${column}`;
            }
            
            checkForAutocomplete() {
                // 简单的自动完成实现
                const cursorPos = this.editor.selectionStart;
                const textBeforeCursor = this.editor.value.substring(0, cursorPos);
                const currentWord = textBeforeCursor.split(/\s+/).pop();
                
                if (currentWord.length < 2) {
                    this.hideAutocomplete();
                    return;
                }
                
                const suggestions = this.getSuggestions(currentWord);
                
                if (suggestions.length > 0) {
                    this.showAutocomplete(suggestions);
                } else {
                    this.hideAutocomplete();
                }
            }
            
            getSuggestions(word) {
                const keywords = [
                    'function', 'const', 'let', 'var', 'if', 'else', 'for', 'while',
                    'return', 'console', 'log', 'document', 'window', 'Math', 'Date'
                ];
                
                return keywords.filter(keyword => 
                    keyword.toLowerCase().startsWith(word.toLowerCase())
                );
            }
            
            showAutocomplete(suggestions) {
                this.autocomplete.innerHTML = '';
                
                suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item' + (index === 0 ? ' active' : '');
                    item.innerHTML = `
                        <i class="fas fa-code"></i>
                        <span>${suggestion}</span>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.acceptSuggestion(suggestion);
                    });
                    
                    this.autocomplete.appendChild(item);
                });
                
                // 简单定位
                this.autocomplete.style.display = 'block';
            }
            
            hideAutocomplete() {
                this.autocomplete.style.display = 'none';
            }
            
            acceptSuggestion(suggestion) {
                const cursorPos = this.editor.selectionStart;
                const textBeforeCursor = this.editor.value.substring(0, cursorPos);
                const words = textBeforeCursor.split(/\s+/);
                const currentWord = words[words.length - 1];
                
                const startPos = cursorPos - currentWord.length;
                const newText = this.editor.value.substring(0, startPos) + 
                               suggestion + 
                               this.editor.value.substring(cursorPos);
                
                this.editor.value = newText;
                this.editor.selectionStart = this.editor.selectionEnd = startPos + suggestion.length;
                this.editor.focus();
                
                this.hideAutocomplete();
                this.updateLineNumbers();
                this.saveState();
            }
            
            saveState() {
                const currentValue = this.editor.value;
                
                if (currentValue !== this.currentState) {
                    this.undoStack.push(this.currentState);
                    this.currentState = currentValue;
                    this.redoStack = [];
                }
            }
            
            undo() {
                if (this.undoStack.length > 0) {
                    this.redoStack.push(this.currentState);
                    this.currentState = this.undoStack.pop();
                    this.editor.value = this.currentState;
                    this.updateLineNumbers();
                    this.updateCursorPosition();
                }
            }
            
            redo() {
                if (this.redoStack.length > 0) {
                    this.undoStack.push(this.currentState);
                    this.currentState = this.redoStack.pop();
                    this.editor.value = this.currentState;
                    this.updateLineNumbers();
                    this.updateCursorPosition();
                }
            }
            
            toggleTheme() {
                this.isDarkTheme = !this.isDarkTheme;
                
                if (this.isDarkTheme) {
                    document.body.style.background = '#1e1e1e';
                    document.body.style.color = '#e0e0e0';
                } else {
                    document.body.style.background = '#ffffff';
                    document.body.style.color = '#333333';
                }
            }
        }
        
        // 初始化编辑器
        document.addEventListener('DOMContentLoaded', () => {
            new MobileCodeEditor();
        });
    </script>
</body>
</html>